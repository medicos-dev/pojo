var De=Object.defineProperty;var Ae=(t,n,s)=>n in t?De(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s;var S=(t,n,s)=>Ae(t,typeof n!="symbol"?n+"":n,s);import{r as o,j as e,_ as Pe}from"./index-C0wZXuOl.js";import{L as Le}from"./lenis-DTHSWqDp.js";function C(t){if(t===0)return"0 Bytes";const n=1024,s=["Bytes","KB","MB","GB","TB"],r=Math.floor(Math.log(t)/Math.log(n));return parseFloat((t/Math.pow(n,r)).toFixed(2))+" "+s[r]}const Oe=({file:t,fileQueue:n,currentIndex:s,progress:r,status:a,error:f,onFilesSelect:m,onStart:l,onPause:c,onResume:p,onAbort:i})=>{const[E,R]=o.useState(!1),L=o.useRef(null),v=u=>{u.preventDefault(),u.stopPropagation(),u.type==="dragenter"||u.type==="dragover"?R(!0):u.type==="dragleave"&&R(!1)},j=u=>{if(u.preventDefault(),u.stopPropagation(),R(!1),u.dataTransfer.files&&u.dataTransfer.files.length>0){const y=Array.from(u.dataTransfer.files);m(y)}},H=u=>{if(u.target.files&&u.target.files.length>0){const y=Array.from(u.target.files);m(y)}};return e.jsxs("div",{className:"retro-card",children:[e.jsx("h2",{className:"font-mono text-amber",style:{marginTop:0},children:"SENDER TERMINAL"}),n.length===0?e.jsxs("div",{className:`drop-zone ${E?"active":""}`,onDragEnter:v,onDragLeave:v,onDragOver:v,onDrop:j,onClick:()=>{var u;return(u=L.current)==null?void 0:u.click()},children:[e.jsx("p",{className:"font-mono",children:"DROP FILES HERE"}),e.jsx("p",{className:"text-muted",style:{fontSize:"0.9rem",marginTop:"0.5rem"},children:"or click to browse (multiple allowed)"}),e.jsx("input",{ref:L,type:"file",multiple:!0,style:{display:"none"},onChange:H})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"font-mono",style:{marginBottom:"1rem"},children:[e.jsxs("div",{style:{fontSize:"0.85rem",marginBottom:"0.5rem",opacity:.7},children:["FILE QUEUE (",s+1,"/",n.length,")"]}),e.jsx("div",{style:{maxHeight:"150px",overflowY:"auto"},children:n.map((u,y)=>e.jsxs("div",{style:{padding:"0.5rem",background:y===s?"rgba(127, 163, 124, 0.2)":"transparent",borderRadius:"8px",display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.25rem"},children:[e.jsxs("span",{className:y<s?"text-green":y===s?"text-amber":"text-muted",children:[y<s?"âœ“ ":y===s?"â–º ":"â—‹ ",u.name.length>25?u.name.slice(0,22)+"...":u.name]}),e.jsx("span",{className:"text-muted",style:{fontSize:"0.8rem"},children:C(u.size)})]},y))})]}),t&&e.jsxs("div",{className:"file-info",children:[e.jsxs("div",{children:["CURRENT: ",e.jsx("span",{className:"text-primary",children:t.name})]}),e.jsxs("div",{children:["SIZE: ",e.jsx("span",{className:"text-muted",children:C(t.size)})]})]}),(a==="idle"||a==="error")&&e.jsxs("div",{style:{display:"flex",gap:"1rem"},children:[e.jsx("button",{className:"retro-btn primary",onClick:l,children:a==="error"?"RETRY":`SEND ${n.length} FILES`}),e.jsx("button",{className:"retro-btn",onClick:i,children:"CLEAR"})]}),a==="waiting"&&e.jsxs("div",{children:[e.jsx("p",{className:"text-amber blink",children:"WAITING FOR PEER ACCEPT..."}),e.jsx("button",{className:"retro-btn",style:{fontSize:"0.8rem",padding:"0.4rem 0.8rem"},onClick:i,children:"CANCEL"})]}),(a==="uploading"||a==="paused")&&r&&e.jsxs("div",{children:[e.jsx("div",{className:"progress-container",children:e.jsx("div",{className:"progress-fill",style:{width:`${r.percent}%`,opacity:a==="paused"?.5:1}})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.9rem",marginBottom:"1rem"},children:[e.jsxs("span",{className:"font-mono",children:[r.percent.toFixed(1),"%"]}),e.jsx("span",{className:"font-mono",children:a==="paused"?"PAUSED":`${C(r.speedBps)}/s`}),e.jsxs("span",{className:"text-muted",children:[C(r.bytesSent)," / ",C(r.totalBytes)]})]}),e.jsxs("div",{style:{display:"flex",gap:"1rem"},children:[a==="uploading"?e.jsx("button",{className:"retro-btn",onClick:c,children:"POSTPONE (PAUSE)"}):e.jsx("button",{className:"retro-btn primary",onClick:p,children:"RESUME"}),e.jsx("button",{className:"retro-btn",style:{borderColor:"var(--accent-red)",color:"var(--accent-red)"},onClick:i,children:"CANCEL"})]})]}),f&&e.jsxs("div",{className:"text-red font-mono",style:{marginTop:"1rem"},children:["ERROR: ",f]}),a==="complete"&&s<n.length-1&&e.jsx("div",{className:"text-amber font-mono",style:{marginTop:"1rem"},children:"STARTING NEXT FILE..."}),a==="complete"&&s>=n.length-1&&e.jsxs("div",{className:"text-green font-mono",style:{marginTop:"1rem",textAlign:"center"},children:["âœ“ ALL TRANSFERS COMPLETE",e.jsx("button",{className:"retro-btn",style:{marginLeft:"1rem"},onClick:i,children:"NEW TRANSFER"})]})]})]})},Ue=({fileMetadata:t,progress:n,status:s,error:r,onAccept:a,onReject:f,onReset:m})=>!t&&s==="idle"?e.jsxs("div",{className:"retro-card",style:{opacity:.7},children:[e.jsx("h2",{className:"font-mono text-muted",style:{marginTop:0},children:"RECEIVER TERMINAL"}),e.jsx("div",{className:"drop-zone",style:{borderStyle:"solid",borderColor:"#333",cursor:"default"},children:e.jsx("p",{className:"text-muted",children:"WAITING FOR INCOMING SIGNALS..."})})]}):e.jsxs("div",{className:"retro-card",children:[e.jsx("h2",{className:"font-mono text-blue",style:{marginTop:0},children:"RECEIVER TERMINAL"}),t&&e.jsxs("div",{className:"font-mono",style:{marginBottom:"1rem"},children:[e.jsx("div",{className:"text-amber",children:"INCOMING TRANSMISSION DETECTED"}),e.jsx("br",{}),e.jsxs("div",{children:["FILE: ",e.jsx("span",{className:"text-primary",children:t.name})]}),e.jsxs("div",{children:["SIZE: ",e.jsx("span",{className:"text-muted",children:C(t.size)})]}),e.jsxs("div",{children:["TYPE: ",e.jsx("span",{className:"text-muted",children:t.mimeType})]})]}),s==="offering"&&e.jsxs("div",{style:{display:"flex",gap:"1rem",marginTop:"1.5rem"},children:[e.jsx("button",{className:"retro-btn primary",onClick:a,children:"ACCEPT DATA"}),e.jsx("button",{className:"retro-btn",onClick:f,children:"REJECT"})]}),(s==="receiving"||s==="complete"||s==="finalizing")&&n&&e.jsxs("div",{children:[e.jsx("div",{className:"progress-container",children:e.jsx("div",{className:"progress-fill",style:{width:`${n.percent}%`}})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.9rem"},children:[e.jsxs("span",{className:"font-mono",children:[n.percent.toFixed(1),"%"]}),e.jsxs("span",{className:"font-mono",children:[C(n.speedBps),"/s"]}),e.jsxs("span",{className:"text-muted",children:[C(n.bytesReceived)," / ",C(n.totalBytes)]})]})]}),s==="finalizing"&&e.jsx("div",{className:"text-amber blink",style:{marginTop:"1rem"},children:"ASSEMBLING FILE ON DISK..."}),s==="complete"&&e.jsxs("div",{className:"text-green font-mono",style:{marginTop:"1rem"},children:[e.jsx("div",{children:"âœ“ RECEPTION COMPLETE"}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.7},children:"File saved to Downloads"}),e.jsx("button",{className:"retro-btn",style:{marginTop:"1rem",marginLeft:"0.5rem"},onClick:m,children:"READY FOR NEXT"})]}),r&&e.jsxs("div",{className:"text-red font-mono",style:{marginTop:"1rem"},children:[e.jsxs("div",{children:["ERROR: ",r]}),e.jsx("button",{className:"retro-btn",style:{marginTop:"1rem",borderColor:"var(--accent-red)",color:"var(--accent-red)"},onClick:m,children:"READY FOR NEXT"})]})]});let q=250*1024;const Fe=4*1024*1024,fe=1*1024*1024,ze=()=>{const t=new URLSearchParams(window.location.search),n=t.get("ws");if(n)return n.startsWith("ws://")||n.startsWith("wss://")?n:n.includes("devtunnels.ms")?`wss://${n}`:`ws://${n}:${t.get("port")||"8080"}`;const s=window.location.hostname,r=window.location.protocol==="https:"?"wss:":"ws:";return s.includes("onrender.com")?`${r}//${s}`:`${r}//${s}:8080`},Me=[{urls:"stun:stun.l.google.com:19302"}];let g=null,$=0;const We=10,_e=2e3;let _=null;const me=t=>{_=t,g&&g.readyState===WebSocket.OPEN&&F({type:"join",room:t})};let K=null;const $e=t=>{K=t},pe=()=>new Promise((t,n)=>{if(g&&(g.readyState===WebSocket.OPEN||g.readyState===WebSocket.CONNECTING)){t(g);return}const s=ze();g=new WebSocket(s),g.onopen=()=>{$=0,_&&F({type:"join",room:_}),t(g)},g.onmessage=r=>{try{const a=JSON.parse(r.data);K&&K(a)}catch{}},g.onclose=r=>{_&&r.code!==1e3&&setTimeout(()=>Ge(),_e)},g.onerror=r=>{$===0&&n(r)}});async function Ge(){if(!($>=We)){$++;try{await pe()}catch{}}}const F=t=>{g&&g.readyState===WebSocket.OPEN&&g.send(JSON.stringify(t))},ye=()=>g;let A=null,w=null,Y=null,X=null,N=null,U=null;const He=5e3,Se=(t,n,s)=>{Y=t,X=n,N=s},Je=()=>A,Ve=()=>w,b=t=>A&&A.readyState==="open"?(A.send(JSON.stringify(t)),!0):!1,Q=t=>{if(w&&w.readyState==="open")try{return w.send(t),!0}catch{return!1}return!1},ae=t=>{A=t,t.onopen=()=>{N&&N("control",!0),qe()},t.onclose=()=>{Ke(),N&&N("control",!1)},t.onmessage=n=>{try{const s=JSON.parse(n.data);Y&&Y(s),s.type==="ping"&&b({type:"pong"})}catch{}}},oe=t=>{w=t,t.binaryType="arraybuffer",t.bufferedAmountLowThreshold=fe,t.onopen=()=>{N&&N("data",!0)},t.onclose=()=>{N&&N("data",!1)},t.onmessage=n=>{n.data instanceof ArrayBuffer&&X&&X(n.data)}};function qe(){U&&clearInterval(U),U=setInterval(()=>{A&&A.readyState==="open"&&b({type:"ping"})},He)}function Ke(){U&&(clearInterval(U),U=null)}const Z=()=>new Promise(t=>{if(!w||w.readyState!=="open"){t();return}if(w.bufferedAmount<=fe){t();return}const n=()=>{w&&w.removeEventListener("bufferedamountlow",n),t()};w.addEventListener("bufferedamountlow",n),setTimeout(()=>{w&&w.removeEventListener("bufferedamountlow",n),t()},500)}),Ye=Object.freeze(Object.defineProperty({__proto__:null,getControlChannel:Je,getDataChannel:Ve,registerDataHandlers:Se,sendControl:b,sendData:Q,setupControlChannel:ae,setupDataChannel:oe,waitForDrain:Z},Symbol.toStringTag,{value:"Module"}));let h=null,ee=null,te=null;const Xe=t=>{te=t},ne=(t,n)=>(h&&h.close(),ee=t,h=new RTCPeerConnection({iceServers:Me}),h.onicecandidate=s=>{const r=ye();s.candidate&&r&&r.readyState===WebSocket.OPEN&&F({type:"ice-candidate",candidate:s.candidate,room:t})},h.onconnectionstatechange=()=>{te&&h&&te(h.connectionState)},h.ondatachannel=s=>{s.channel.label==="control"?ae(s.channel):s.channel.label==="data"&&oe(s.channel)},n&&Qe(h),h);function Qe(t){const n=t.createDataChannel("control",{ordered:!0});ae(n);const s=t.createDataChannel("data",{ordered:!0});oe(s)}let se=[];async function ge(){if(!(!h||!h.remoteDescription))for(;se.length>0;){const t=se.shift();if(t)try{await h.addIceCandidate(new RTCIceCandidate(t))}catch{}}}const Ze=async t=>{if(h||ne(ee,!1),!!h){h.signalingState!=="stable"&&h.signalingState;try{await h.setRemoteDescription(new RTCSessionDescription(t)),await ge();const n=await h.createAnswer();await h.setLocalDescription(n),F({type:"answer",answer:n,room:ee})}catch{}}},et=async t=>{if(h&&h.signalingState!=="stable")try{await h.setRemoteDescription(new RTCSessionDescription(t)),await ge()}catch{}},tt=async t=>{if(h){if(!h.remoteDescription){se.push(t);return}try{await h.addIceCandidate(new RTCIceCandidate(t))}catch{}}},nt=t=>{const[n,s]=o.useState("Connecting..."),[r,a]=o.useState("new");o.useEffect(()=>{const c=()=>{const i=ye();i?i.readyState===WebSocket.OPEN?s("Connected"):i.readyState===WebSocket.CONNECTING?s("Connecting..."):s("Disconnected"):s("Connecting...")};c();const p=setInterval(c,1e3);return()=>clearInterval(p)},[]),o.useEffect(()=>{Xe(c=>{a(c)})},[]);const f=()=>r==="connected"?"status-dot connected":r==="failed"||r==="closed"?"status-dot error":r==="connecting"?"status-dot connecting":"status-dot waiting",m=()=>r==="connected"?"ðŸ”’ SECURE CONNECTION":r==="connecting"?"ðŸ”„ NEGOTIATING...":r==="disconnected"?"âŒ PEER DISCONNECTED":"â³ WAITING FOR PEER",l=()=>r==="connected"?"status-connected":r==="connecting"?"status-waiting":"";return e.jsxs("div",{className:"status-bar",children:[e.jsxs("div",{className:"status-left",children:[e.jsx("span",{className:f()}),e.jsx("span",{className:`status-text ${l()}`,children:m()})]}),e.jsx("div",{className:"status-right",children:e.jsxs("span",{className:n==="Connected"?"text-green":"text-amber",children:["â— ",n.toUpperCase()]})})]})},xe=()=>{const[t,n]=o.useState(!1),[s,r]=o.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx("footer",{className:"app-footer",children:e.jsxs("div",{className:"footer-content",children:[e.jsxs("div",{className:"developer-info",onClick:()=>r(!0),style:{cursor:"pointer"},children:[e.jsx("img",{src:"/aiks1.jpg",alt:"Developer",className:"developer-avatar"}),e.jsx("span",{className:"developer-name",children:"AIKS"})]}),e.jsx("button",{className:"btn-donate",onClick:()=>n(!0),children:"ðŸ’Œ Thank Me."})]})}),s&&e.jsx("div",{className:"modal-overlay",onClick:()=>r(!1),children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[e.jsx("button",{className:"modal-close",onClick:()=>r(!1),children:"Ã—"}),e.jsx("img",{src:"/aiks1.jpg",alt:"Developer",className:"donation-image",style:{borderRadius:"50%",width:"300px",height:"300px",objectFit:"cover"}})]})}),t&&e.jsx("div",{className:"modal-overlay",onClick:()=>n(!1),children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[e.jsx("button",{className:"modal-close",onClick:()=>n(!1),children:"Ã—"}),e.jsx("img",{src:"/donate.png",alt:"Donation QR",className:"donation-image"})]})})]})};class st{constructor(n,s,r){S(this,"file");S(this,"onProgress");S(this,"onStatus");S(this,"aborted",!1);S(this,"paused",!1);S(this,"totalBytesSent",0);S(this,"lastSpeedUpdate",0);S(this,"lastBytesForSpeed",0);S(this,"lastUIUpdate",0);S(this,"currentSpeed",0);this.file=n,this.onProgress=s,this.onStatus=r}abort(){this.aborted=!0}pause(){this.paused=!0}resume(){this.paused=!1}async start(){this.onStatus("uploading"),this.totalBytesSent=0,this.lastSpeedUpdate=Date.now(),this.lastBytesForSpeed=0,this.lastUIUpdate=0;const n=Math.ceil(this.file.size/q);try{if("wakeLock"in navigator)try{await navigator.wakeLock.request("screen")}catch{}for(let s=0;s<n;s++){if(this.aborted)throw new Error("Aborted");for(;this.paused;){if(this.aborted)throw new Error("Aborted");await new Promise(i=>setTimeout(i,100)),this.lastSpeedUpdate=Date.now(),this.lastBytesForSpeed=this.totalBytesSent,this.updateStats()}const r=s*q,a=Math.min(r+q,this.file.size),m=await this.file.slice(r,a).arrayBuffer(),l=new ArrayBuffer(4+m.byteLength);new DataView(l).setUint32(0,s,!0),new Uint8Array(l,4).set(new Uint8Array(m));const c=await Pe(()=>Promise.resolve().then(()=>Ye),void 0).then(i=>i.getDataChannel());if(c&&c.readyState==="open"){for(;c.bufferedAmount>Fe;)if(await Z(),this.aborted)throw new Error("Aborted")}else if(c&&c.readyState!=="open")throw new Error("Data channel closed");let p=Q(l);if(!p&&(await Z(),p=Q(l),!p))throw new Error("Data channel closed or failed");this.totalBytesSent+=m.byteLength,this.updateStats()}this.updateStats(!0),this.onStatus("complete")}catch(s){this.onStatus("error",s.message)}}updateStats(n=!1){const s=Date.now();if(n||s-this.lastUIUpdate>100||this.totalBytesSent>=this.file.size||this.paused){this.lastUIUpdate=s;let r=this.currentSpeed;const a=(s-this.lastSpeedUpdate)/1e3;this.paused?(r=0,this.currentSpeed=0):a>=.5?(r=(this.totalBytesSent-this.lastBytesForSpeed)/a,this.currentSpeed=r,this.lastSpeedUpdate=s,this.lastBytesForSpeed=this.totalBytesSent):this.lastBytesForSpeed===0&&a>.1&&(r=this.totalBytesSent/a,this.currentSpeed=r),this.onProgress({bytesSent:this.totalBytesSent,totalBytes:this.file.size,percent:this.totalBytesSent/this.file.size*100,speedBps:r})}}}const rt="FileTransferDB",I="chunks";let P=null;const at=()=>new Promise((t,n)=>{const s=indexedDB.open(rt,1);s.onupgradeneeded=r=>{const a=r.target.result;a.objectStoreNames.contains(I)||a.createObjectStore(I,{keyPath:["fileName","chunkIndex"]})},s.onsuccess=r=>{P=r.target.result,t()},s.onerror=r=>n(r)}),ot=(t,n,s)=>P?new Promise((r,a)=>{const f=P.transaction(I,"readwrite");f.objectStore(I).put({fileName:t,chunkIndex:n,data:s}),f.oncomplete=()=>r(),f.onerror=()=>a(f.error)}):Promise.reject("DB not initialized"),it=t=>P?new Promise((n,s)=>{const a=P.transaction(I,"readonly").objectStore(I),f=IDBKeyRange.bound([t,0],[t,1/0]),m=a.openCursor(f),l=[];m.onsuccess=c=>{const p=c.target.result;p?(l.push(new Blob([p.value.data])),p.continue()):n(l)},m.onerror=()=>s(m.error)}):Promise.reject("DB not initialized"),lt=t=>P?new Promise((n,s)=>{const a=P.transaction(I,"readwrite").objectStore(I),f=IDBKeyRange.bound([t,0],[t,1/0]),m=a.delete(f);m.onsuccess=()=>n(),m.onerror=()=>s(m.error)}):Promise.reject("DB not initialized"),G=[];let ve=0,re=!1;const ct=t=>{G.push(t),ve+=t.data.byteLength,re||dt()};async function dt(){for(re=!0;G.length>0;){const t=G.shift();if(t){ve-=t.data.byteLength;try{await ot(t.fileName,t.chunkIndex,t.data)}catch{}}}re=!1}class ut{constructor(n,s,r){S(this,"metadata");S(this,"onProgress");S(this,"onStatus");S(this,"totalBytesReceived",0);S(this,"receivedChunkCount",0);S(this,"lastSpeedUpdate",0);S(this,"lastBytesForSpeed",0);S(this,"lastUIUpdate",0);S(this,"currentSpeed",0);this.metadata=n,this.onProgress=s,this.onStatus=r,this.lastSpeedUpdate=Date.now()}handleChunk(n){const r=new DataView(n).getUint32(0,!0),a=n.slice(4);this.totalBytesReceived+=a.byteLength,this.receivedChunkCount++,this.updateStats(),ct({fileName:this.metadata.name,chunkIndex:r,data:a}),this.receivedChunkCount%40===0&&b({type:"ack",chunkIndex:r,bytesReceived:this.totalBytesReceived}),this.totalBytesReceived>=this.metadata.size&&this.finalize()}updateStats(){const n=Date.now();if(n-this.lastUIUpdate>100||this.totalBytesReceived>=this.metadata.size){this.lastUIUpdate=n;let s=this.currentSpeed;const r=(n-this.lastSpeedUpdate)/1e3;r>=.5?(s=(this.totalBytesReceived-this.lastBytesForSpeed)/r,this.currentSpeed=s,this.lastSpeedUpdate=n,this.lastBytesForSpeed=this.totalBytesReceived):this.lastBytesForSpeed===0&&r>.1&&(s=this.totalBytesReceived/r,this.currentSpeed=s),this.onProgress({bytesReceived:this.totalBytesReceived,totalBytes:this.metadata.size,percent:this.totalBytesReceived/this.metadata.size*100,speedBps:s})}}async finalize(){for(this.onStatus("receiving","finalizing");G.length>0;)await new Promise(n=>setTimeout(n,50));try{const n=await it(this.metadata.name),s=new Blob(n,{type:this.metadata.mimeType});await lt(this.metadata.name),this.onStatus("complete",s),b({type:"file-complete",bytesReceived:this.totalBytesReceived})}catch(n){this.onStatus("error",n.message)}}}const ht=({roomId:t,onLeave:n})=>{const[s,r]=o.useState("idle"),[a,f]=o.useState(!1),[m,l]=o.useState(null),[c,p]=o.useState([]),[i,E]=o.useState(0),[R,L]=o.useState(null),[v,j]=o.useState("idle"),[H,u]=o.useState(null),y=o.useRef(null),[z,ie]=o.useState(!1),[M,J]=o.useState(null),[we,le]=o.useState(null),[je,T]=o.useState("idle"),[Ce,W]=o.useState(null),O=o.useRef(null),B=o.useRef(s),V=o.useRef(v);o.useEffect(()=>{B.current=s},[s]),o.useEffect(()=>{V.current=v},[v]);const Ne=()=>{navigator.clipboard.writeText(t),f(!0),setTimeout(()=>f(!1),2e3)},ce=o.useCallback((d,x)=>{},[]),de=o.useCallback(d=>{switch(d.type){case"file-request":if(le(null),O.current=null,B.current==="sender")return;r("receiver"),J({name:d.name,size:d.size,mimeType:d.mimeType||"application/octet-stream"}),T("offering"),W(null);break;case"file-accept":B.current==="sender"&&V.current==="waiting"&&y.current&&y.current.start();break;case"file-reject":B.current==="sender"&&(j("error"),u("Peer rejected file transfer."));break;case"ack":break;case"file-complete":B.current==="sender"&&V.current==="complete"&&ie(!1);break;case"cancel":B.current==="receiver"&&(T("error"),W("Transfer cancelled by sender."),O.current);break}},[]),ue=o.useCallback(d=>{O.current&&B.current==="receiver"&&O.current.handleChunk(d)},[]);o.useEffect(()=>{at().catch(()=>{}),Se(de,ue,ce)},[de,ue,ce]);const be=d=>{r("sender"),p(d),E(0),l(d[0]),j("idle"),u(null),L(null)},he=d=>{const x=d||m;x&&(y.current=new st(x,k=>L(k),(k,D)=>{k==="uploading"&&j("uploading"),k==="complete"&&(i<c.length-1&&ie(!0),j("complete")),k==="error"&&(j("error"),u(D||"Unknown error"))}),j("waiting"),b({type:"file-request",name:x.name,size:x.size,mimeType:x.type}))};o.useEffect(()=>{!z&&v==="complete"&&i<c.length-1},[z]),o.useEffect(()=>{if(v==="complete"&&!z&&i<c.length-1){const d=i+1;E(d),l(c[d]),j("idle"),L(null),setTimeout(()=>{he(c[d])},500)}},[z,v]);const Ee=()=>{y.current&&y.current.abort(),s==="sender"&&(v==="uploading"||v==="waiting"||v==="paused")&&b({type:"cancel"}),r("idle"),l(null),p([]),E(0)};o.useEffect(()=>{const d=x=>{t&&(x.preventDefault(),x.returnValue="")};return window.addEventListener("beforeunload",d),()=>window.removeEventListener("beforeunload",d)},[t]);const Re=()=>{M&&(T("receiving"),O.current=new ut(M,d=>le(d),(d,x)=>{d==="receiving"&&T("receiving"),d==="receiving"&&x==="finalizing"&&T("finalizing"),d==="complete"&&(T("complete"),ke(x,M.name)),d==="error"&&(T("error"),W(x))}),b({type:"file-accept"}))},Te=()=>{b({type:"file-reject"}),r("idle"),J(null)},ke=(d,x)=>{const k=URL.createObjectURL(d),D=document.createElement("a");D.href=k,D.download=x,document.body.appendChild(D),D.click(),document.body.removeChild(D),setTimeout(()=>URL.revokeObjectURL(k),1e3)},Ie=()=>{r("idle"),J(null),T("idle"),W(null),Be(null)},Be=d=>{O.current=d};return e.jsx("div",{className:"app-container",children:e.jsxs("div",{style:{maxWidth:"550px",width:"100%"},children:[e.jsxs("div",{className:"retro-card",style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1.5rem",padding:"1.2rem 1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx("div",{className:"font-mono text-muted",style:{fontSize:"0.85rem"},children:"ROOM"}),e.jsx("div",{className:"font-mono room-code",children:t}),e.jsx("button",{className:"retro-btn",style:{padding:"0.5rem 1rem",fontSize:"0.75rem"},onClick:Ne,children:a?"âœ“ COPIED":"COPY"})]}),e.jsx("button",{className:"retro-btn",onClick:n,style:{borderColor:"var(--accent-red)",color:"var(--accent-red)",padding:"0.5rem 1rem",fontSize:"0.75rem"},children:"LEAVE"})]}),e.jsx(nt,{roomId:t}),e.jsx("div",{style:{marginTop:"2rem"},children:s==="receiver"?e.jsx(Ue,{fileMetadata:M,progress:we,status:je,error:Ce,onAccept:Re,onReject:Te,onReset:Ie}):e.jsx(Oe,{file:m,fileQueue:c,currentIndex:i,progress:R,status:v,error:H,onFilesSelect:be,onStart:()=>he(),onPause:()=>{y.current&&y.current.pause(),j("paused")},onResume:()=>{y.current&&y.current.resume(),j("uploading")},onAbort:Ee})}),e.jsx(xe,{})]})})},mt=({onJoin:t,onCreate:n})=>{const[s,r]=o.useState(""),a=()=>{s.length>0&&t(s.toUpperCase())};return e.jsxs("div",{className:"app-container",children:[e.jsx("h1",{style:{fontFamily:"var(--font-heading)",fontSize:"3rem",color:"var(--text-primary)",margin:0,textAlign:"center",marginBottom:"2rem"},children:"POJO FILES"}),e.jsx("div",{className:"retro-card",style:{width:"100%",maxWidth:"400px"},children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-mono text-muted",style:{fontSize:"0.9rem"},children:"ENTER ROOM CODE"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.5rem"},children:[e.jsx("input",{className:"retro-input",value:s,onChange:f=>r(f.target.value.toUpperCase()),placeholder:"A7X92B",maxLength:6,style:{textAlign:"center",letterSpacing:"0.2em",fontSize:"1.2rem",fontWeight:"bold"}}),e.jsx("button",{className:"retro-btn",onClick:a,disabled:s.length<3,children:"JOIN"})]})]}),e.jsx("div",{style:{textAlign:"center",opacity:.5,fontSize:"0.8rem"},className:"font-mono",children:"â€” OR â€”"}),e.jsx("button",{className:"retro-btn primary",onClick:n,children:"CREATE NEW ROOM"})]})}),e.jsx(xe,{})]})};function ft(){const[t,n]=o.useState(null);o.useEffect(()=>{const l=new Le({duration:1.2,easing:p=>Math.min(1,1.001-Math.pow(2,-10*p))});function c(p){l.raf(p),requestAnimationFrame(c)}return requestAnimationFrame(c),window.scrollTo(0,0),()=>{l.destroy()}},[]);const s=()=>Math.random().toString(36).substring(2,8).toUpperCase(),r=async(l,c)=>{n(l),me(l);const p=new URL(window.location.href);p.searchParams.set("room",l),window.history.pushState({},"",p.toString());try{await pe(),$e(async i=>{if(i.type==="joined"&&i.isInitiator,i.type==="peer-joined"){if(c){const E=ne(l,!0),R=await E.createOffer();await E.setLocalDescription(R),F({type:"offer",offer:R,room:l})}}else i.type==="room-state"?i.peerCount&&i.peerCount>1:i.type==="offer"?c||(ne(l,!1),i.offer&&await Ze(i.offer)):i.type==="answer"?c&&i.answer&&await et(i.answer):i.type==="ice-candidate"&&i.candidate&&await tt(i.candidate)})}catch{}};o.useEffect(()=>{const c=new URLSearchParams(window.location.search).get("room");if(c){const p=sessionStorage.getItem("isInitiator")==="true";r(c,p)}},[]);const a=()=>{const l=s();sessionStorage.setItem("isInitiator","true"),r(l,!0)},f=l=>{sessionStorage.setItem("isInitiator","false"),r(l,!1)},m=()=>{n(null),sessionStorage.removeItem("isInitiator"),me("");const l=new URL(window.location.href);l.searchParams.delete("room"),window.history.pushState({},"",l.toString()),window.location.reload()};return t?e.jsx(ht,{roomId:t,onLeave:m}):e.jsx(mt,{onJoin:f,onCreate:a})}const gt=()=>e.jsx(ft,{});export{gt as default};
