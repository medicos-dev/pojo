var Ie=Object.defineProperty;var Be=(t,n,s)=>n in t?Ie(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s;var S=(t,n,s)=>Be(t,typeof n!="symbol"?n+"":n,s);import{r as o,j as e,_ as De}from"./index-T1ET-pW7.js";import{L as Ae}from"./lenis-DTHSWqDp.js";function C(t){if(t===0)return"0 Bytes";const n=1024,s=["Bytes","KB","MB","GB","TB"],r=Math.floor(Math.log(t)/Math.log(n));return parseFloat((t/Math.pow(n,r)).toFixed(2))+" "+s[r]}const Pe=({file:t,fileQueue:n,currentIndex:s,progress:r,status:a,error:f,onFilesSelect:m,onStart:i,onPause:c,onResume:p,onAbort:l})=>{const[E,R]=o.useState(!1),P=o.useRef(null),v=u=>{u.preventDefault(),u.stopPropagation(),u.type==="dragenter"||u.type==="dragover"?R(!0):u.type==="dragleave"&&R(!1)},j=u=>{if(u.preventDefault(),u.stopPropagation(),R(!1),u.dataTransfer.files&&u.dataTransfer.files.length>0){const y=Array.from(u.dataTransfer.files);m(y)}},G=u=>{if(u.target.files&&u.target.files.length>0){const y=Array.from(u.target.files);m(y)}};return e.jsxs("div",{className:"retro-card",children:[e.jsx("h2",{className:"font-mono text-amber",style:{marginTop:0},children:"SENDER TERMINAL"}),n.length===0?e.jsxs("div",{className:`drop-zone ${E?"active":""}`,onDragEnter:v,onDragLeave:v,onDragOver:v,onDrop:j,onClick:()=>{var u;return(u=P.current)==null?void 0:u.click()},children:[e.jsx("p",{className:"font-mono",children:"DROP FILES HERE"}),e.jsx("p",{className:"text-muted",style:{fontSize:"0.9rem",marginTop:"0.5rem"},children:"or click to browse (multiple allowed)"}),e.jsx("input",{ref:P,type:"file",multiple:!0,style:{display:"none"},onChange:G})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"font-mono",style:{marginBottom:"1rem"},children:[e.jsxs("div",{style:{fontSize:"0.85rem",marginBottom:"0.5rem",opacity:.7},children:["FILE QUEUE (",s+1,"/",n.length,")"]}),e.jsx("div",{style:{maxHeight:"150px",overflowY:"auto"},children:n.map((u,y)=>e.jsxs("div",{style:{padding:"0.5rem",background:y===s?"rgba(127, 163, 124, 0.2)":"transparent",borderRadius:"8px",display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.25rem"},children:[e.jsxs("span",{className:y<s?"text-green":y===s?"text-amber":"text-muted",children:[y<s?"âœ“ ":y===s?"â–º ":"â—‹ ",u.name.length>25?u.name.slice(0,22)+"...":u.name]}),e.jsx("span",{className:"text-muted",style:{fontSize:"0.8rem"},children:C(u.size)})]},y))})]}),t&&e.jsxs("div",{className:"file-info",children:[e.jsxs("div",{children:["CURRENT: ",e.jsx("span",{className:"text-primary",children:t.name})]}),e.jsxs("div",{children:["SIZE: ",e.jsx("span",{className:"text-muted",children:C(t.size)})]})]}),(a==="idle"||a==="error")&&e.jsxs("div",{style:{display:"flex",gap:"1rem"},children:[e.jsx("button",{className:"retro-btn primary",onClick:i,children:a==="error"?"RETRY":`SEND ${n.length} FILES`}),e.jsx("button",{className:"retro-btn",onClick:l,children:"CLEAR"})]}),a==="waiting"&&e.jsxs("div",{children:[e.jsx("p",{className:"text-amber blink",children:"WAITING FOR PEER ACCEPT..."}),e.jsx("button",{className:"retro-btn",style:{fontSize:"0.8rem",padding:"0.4rem 0.8rem"},onClick:l,children:"CANCEL"})]}),(a==="uploading"||a==="paused")&&r&&e.jsxs("div",{children:[e.jsx("div",{className:"progress-container",children:e.jsx("div",{className:"progress-fill",style:{width:`${r.percent}%`,opacity:a==="paused"?.5:1}})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.9rem",marginBottom:"1rem"},children:[e.jsxs("span",{className:"font-mono",children:[r.percent.toFixed(1),"%"]}),e.jsx("span",{className:"font-mono",children:a==="paused"?"PAUSED":`${C(r.speedBps)}/s`}),e.jsxs("span",{className:"text-muted",children:[C(r.bytesSent)," / ",C(r.totalBytes)]})]}),e.jsxs("div",{style:{display:"flex",gap:"1rem"},children:[a==="uploading"?e.jsx("button",{className:"retro-btn",onClick:c,children:"POSTPONE (PAUSE)"}):e.jsx("button",{className:"retro-btn primary",onClick:p,children:"RESUME"}),e.jsx("button",{className:"retro-btn",style:{borderColor:"var(--accent-red)",color:"var(--accent-red)"},onClick:l,children:"CANCEL"})]})]}),f&&e.jsxs("div",{className:"text-red font-mono",style:{marginTop:"1rem"},children:["ERROR: ",f]}),a==="complete"&&s<n.length-1&&e.jsx("div",{className:"text-amber font-mono",style:{marginTop:"1rem"},children:"STARTING NEXT FILE..."}),a==="complete"&&s>=n.length-1&&e.jsxs("div",{className:"text-green font-mono",style:{marginTop:"1rem",textAlign:"center"},children:["âœ“ ALL TRANSFERS COMPLETE",e.jsx("button",{className:"retro-btn",style:{marginLeft:"1rem"},onClick:l,children:"NEW TRANSFER"})]})]})]})},Le=({fileMetadata:t,progress:n,status:s,error:r,onAccept:a,onReject:f,onReset:m})=>!t&&s==="idle"?e.jsxs("div",{className:"retro-card",style:{opacity:.7},children:[e.jsx("h2",{className:"font-mono text-muted",style:{marginTop:0},children:"RECEIVER TERMINAL"}),e.jsx("div",{className:"drop-zone",style:{borderStyle:"solid",borderColor:"#333",cursor:"default"},children:e.jsx("p",{className:"text-muted",children:"WAITING FOR INCOMING SIGNALS..."})})]}):e.jsxs("div",{className:"retro-card",children:[e.jsx("h2",{className:"font-mono text-blue",style:{marginTop:0},children:"RECEIVER TERMINAL"}),t&&e.jsxs("div",{className:"font-mono",style:{marginBottom:"1rem"},children:[e.jsx("div",{className:"text-amber",children:"INCOMING TRANSMISSION DETECTED"}),e.jsx("br",{}),e.jsxs("div",{children:["FILE: ",e.jsx("span",{className:"text-primary",children:t.name})]}),e.jsxs("div",{children:["SIZE: ",e.jsx("span",{className:"text-muted",children:C(t.size)})]}),e.jsxs("div",{children:["TYPE: ",e.jsx("span",{className:"text-muted",children:t.mimeType})]})]}),s==="offering"&&e.jsxs("div",{style:{display:"flex",gap:"1rem",marginTop:"1.5rem"},children:[e.jsx("button",{className:"retro-btn primary",onClick:a,children:"ACCEPT DATA"}),e.jsx("button",{className:"retro-btn",onClick:f,children:"REJECT"})]}),(s==="receiving"||s==="complete"||s==="finalizing")&&n&&e.jsxs("div",{children:[e.jsx("div",{className:"progress-container",children:e.jsx("div",{className:"progress-fill",style:{width:`${n.percent}%`}})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.9rem"},children:[e.jsxs("span",{className:"font-mono",children:[n.percent.toFixed(1),"%"]}),e.jsxs("span",{className:"font-mono",children:[C(n.speedBps),"/s"]}),e.jsxs("span",{className:"text-muted",children:[C(n.bytesReceived)," / ",C(n.totalBytes)]})]})]}),s==="finalizing"&&e.jsx("div",{className:"text-amber blink",style:{marginTop:"1rem"},children:"ASSEMBLING FILE ON DISK..."}),s==="complete"&&e.jsxs("div",{className:"text-green font-mono",style:{marginTop:"1rem"},children:[e.jsx("div",{children:"âœ“ RECEPTION COMPLETE"}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.7},children:"File saved to Downloads"}),e.jsx("button",{className:"retro-btn",style:{marginTop:"1rem",marginLeft:"0.5rem"},onClick:m,children:"READY FOR NEXT"})]}),r&&e.jsxs("div",{className:"text-red font-mono",style:{marginTop:"1rem"},children:[e.jsxs("div",{children:["ERROR: ",r]}),e.jsx("button",{className:"retro-btn",style:{marginTop:"1rem",borderColor:"var(--accent-red)",color:"var(--accent-red)"},onClick:m,children:"READY FOR NEXT"})]})]});let J=250*1024;const Oe=4*1024*1024,ue=1*1024*1024,Ue=()=>{const t=new URLSearchParams(window.location.search),n=t.get("ws");if(n)return n.startsWith("ws://")||n.startsWith("wss://")?n:n.includes("devtunnels.ms")?`wss://${n}`:`ws://${n}:${t.get("port")||"8080"}`;const s=window.location.hostname,r=window.location.protocol==="https:"?"wss:":"ws:";return s.includes("onrender.com")?`${r}//${s}`:`${r}//${s}:8080`},Fe=[{urls:"stun:stun.l.google.com:19302"}];let g=null,W=0;const ze=10,Me=2e3;let _=null;const de=t=>{_=t,g&&g.readyState===WebSocket.OPEN&&F({type:"join",room:t})};let V=null;const _e=t=>{V=t},he=()=>new Promise((t,n)=>{if(g&&(g.readyState===WebSocket.OPEN||g.readyState===WebSocket.CONNECTING)){t(g);return}const s=Ue();g=new WebSocket(s),g.onopen=()=>{W=0,_&&F({type:"join",room:_}),t(g)},g.onmessage=r=>{try{const a=JSON.parse(r.data);V&&V(a)}catch{}},g.onclose=r=>{_&&r.code!==1e3&&setTimeout(()=>We(),Me)},g.onerror=r=>{W===0&&n(r)}});async function We(){if(!(W>=ze)){W++;try{await he()}catch{}}}const F=t=>{g&&g.readyState===WebSocket.OPEN&&g.send(JSON.stringify(t))},me=()=>g;let D=null,w=null,q=null,K=null,N=null,O=null;const $e=5e3,fe=(t,n,s)=>{q=t,K=n,N=s},Ge=()=>D,He=()=>w,b=t=>D&&D.readyState==="open"?(D.send(JSON.stringify(t)),!0):!1,Y=t=>{if(w&&w.readyState==="open")try{return w.send(t),!0}catch{return!1}return!1},se=t=>{D=t,t.onopen=()=>{N&&N("control",!0),Je()},t.onclose=()=>{Ve(),N&&N("control",!1)},t.onmessage=n=>{try{const s=JSON.parse(n.data);q&&q(s),s.type==="ping"&&b({type:"pong"})}catch{}}},re=t=>{w=t,t.binaryType="arraybuffer",t.bufferedAmountLowThreshold=ue,t.onopen=()=>{N&&N("data",!0)},t.onclose=()=>{N&&N("data",!1)},t.onmessage=n=>{n.data instanceof ArrayBuffer&&K&&K(n.data)}};function Je(){O&&clearInterval(O),O=setInterval(()=>{D&&D.readyState==="open"&&b({type:"ping"})},$e)}function Ve(){O&&(clearInterval(O),O=null)}const X=()=>new Promise(t=>{if(!w||w.readyState!=="open"){t();return}if(w.bufferedAmount<=ue){t();return}const n=()=>{w&&w.removeEventListener("bufferedamountlow",n),t()};w.addEventListener("bufferedamountlow",n),setTimeout(()=>{w&&w.removeEventListener("bufferedamountlow",n),t()},500)}),qe=Object.freeze(Object.defineProperty({__proto__:null,getControlChannel:Ge,getDataChannel:He,registerDataHandlers:fe,sendControl:b,sendData:Y,setupControlChannel:se,setupDataChannel:re,waitForDrain:X},Symbol.toStringTag,{value:"Module"}));let h=null,Q=null,Z=null;const Ke=t=>{Z=t},ee=(t,n)=>(h&&h.close(),Q=t,h=new RTCPeerConnection({iceServers:Fe}),h.onicecandidate=s=>{const r=me();s.candidate&&r&&r.readyState===WebSocket.OPEN&&F({type:"ice-candidate",candidate:s.candidate,room:t})},h.onconnectionstatechange=()=>{Z&&h&&Z(h.connectionState)},h.ondatachannel=s=>{s.channel.label==="control"?se(s.channel):s.channel.label==="data"&&re(s.channel)},n&&Ye(h),h);function Ye(t){const n=t.createDataChannel("control",{ordered:!0});se(n);const s=t.createDataChannel("data",{ordered:!0});re(s)}let te=[];async function pe(){if(!(!h||!h.remoteDescription))for(;te.length>0;){const t=te.shift();if(t)try{await h.addIceCandidate(new RTCIceCandidate(t))}catch{}}}const Xe=async t=>{if(h||ee(Q,!1),!!h){h.signalingState!=="stable"&&h.signalingState;try{await h.setRemoteDescription(new RTCSessionDescription(t)),await pe();const n=await h.createAnswer();await h.setLocalDescription(n),F({type:"answer",answer:n,room:Q})}catch{}}},Qe=async t=>{if(h&&h.signalingState!=="stable")try{await h.setRemoteDescription(new RTCSessionDescription(t)),await pe()}catch{}},Ze=async t=>{if(h){if(!h.remoteDescription){te.push(t);return}try{await h.addIceCandidate(new RTCIceCandidate(t))}catch{}}},et=t=>{const[n,s]=o.useState("Connecting..."),[r,a]=o.useState("new");o.useEffect(()=>{const c=me();if(c){s(c.readyState===WebSocket.OPEN?"Connected":"Disconnected");const p=setInterval(()=>{s(c.readyState===WebSocket.OPEN?"Connected":"Connecting...")},2e3);return()=>clearInterval(p)}},[]),o.useEffect(()=>{Ke(c=>{a(c)})},[]);const f=()=>r==="connected"?"status-dot connected":r==="failed"||r==="closed"?"status-dot error":r==="connecting"?"status-dot connecting":"status-dot waiting",m=()=>r==="connected"?"ðŸ”’ SECURE CONNECTION":r==="connecting"?"ðŸ”„ NEGOTIATING...":r==="disconnected"?"âŒ PEER DISCONNECTED":"â³ WAITING FOR PEER",i=()=>r==="connected"?"status-connected":r==="connecting"?"status-waiting":"";return e.jsxs("div",{className:"status-bar",children:[e.jsxs("div",{className:"status-left",children:[e.jsx("span",{className:f()}),e.jsx("span",{className:`status-text ${i()}`,children:m()})]}),e.jsx("div",{className:"status-right",children:e.jsxs("span",{className:n==="Connected"?"text-green":"text-amber",children:["â— ",n.toUpperCase()]})})]})},ye=()=>{const[t,n]=o.useState(!1),[s,r]=o.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx("footer",{className:"app-footer",children:e.jsxs("div",{className:"footer-content",children:[e.jsxs("div",{className:"developer-info",onClick:()=>r(!0),style:{cursor:"pointer"},children:[e.jsx("img",{src:"/aiks.jpg",alt:"Developer",className:"developer-avatar"}),e.jsx("span",{className:"developer-name",children:"AIKS"})]}),e.jsx("button",{className:"btn-donate",onClick:()=>n(!0),children:"ðŸ’Œ Thank Me."})]})}),s&&e.jsx("div",{className:"modal-overlay",onClick:()=>r(!1),children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[e.jsx("button",{className:"modal-close",onClick:()=>r(!1),children:"Ã—"}),e.jsx("img",{src:"/aiks.jpg",alt:"Developer",className:"donation-image",style:{borderRadius:"50%",width:"300px",height:"300px",objectFit:"cover"}})]})}),t&&e.jsx("div",{className:"modal-overlay",onClick:()=>n(!1),children:e.jsxs("div",{className:"modal-content",onClick:a=>a.stopPropagation(),children:[e.jsx("button",{className:"modal-close",onClick:()=>n(!1),children:"Ã—"}),e.jsx("img",{src:"/donate.png",alt:"Donation QR",className:"donation-image"})]})})]})};class tt{constructor(n,s,r){S(this,"file");S(this,"onProgress");S(this,"onStatus");S(this,"aborted",!1);S(this,"paused",!1);S(this,"totalBytesSent",0);S(this,"lastSpeedUpdate",0);S(this,"lastBytesForSpeed",0);S(this,"lastUIUpdate",0);S(this,"currentSpeed",0);this.file=n,this.onProgress=s,this.onStatus=r}abort(){this.aborted=!0}pause(){this.paused=!0}resume(){this.paused=!1}async start(){this.onStatus("uploading"),this.totalBytesSent=0,this.lastSpeedUpdate=Date.now(),this.lastBytesForSpeed=0,this.lastUIUpdate=0;const n=Math.ceil(this.file.size/J);try{if("wakeLock"in navigator)try{await navigator.wakeLock.request("screen")}catch{}for(let s=0;s<n;s++){if(this.aborted)throw new Error("Aborted");for(;this.paused;){if(this.aborted)throw new Error("Aborted");await new Promise(l=>setTimeout(l,100)),this.lastSpeedUpdate=Date.now(),this.lastBytesForSpeed=this.totalBytesSent,this.updateStats()}const r=s*J,a=Math.min(r+J,this.file.size),m=await this.file.slice(r,a).arrayBuffer(),i=new ArrayBuffer(4+m.byteLength);new DataView(i).setUint32(0,s,!0),new Uint8Array(i,4).set(new Uint8Array(m));const c=await De(()=>Promise.resolve().then(()=>qe),void 0).then(l=>l.getDataChannel());if(c&&c.readyState==="open"){for(;c.bufferedAmount>Oe;)if(await X(),this.aborted)throw new Error("Aborted")}else if(c&&c.readyState!=="open")throw new Error("Data channel closed");let p=Y(i);if(!p&&(await X(),p=Y(i),!p))throw new Error("Data channel closed or failed");this.totalBytesSent+=m.byteLength,this.updateStats()}this.updateStats(!0),this.onStatus("complete")}catch(s){this.onStatus("error",s.message)}}updateStats(n=!1){const s=Date.now();if(n||s-this.lastUIUpdate>100||this.totalBytesSent>=this.file.size||this.paused){this.lastUIUpdate=s;let r=this.currentSpeed;const a=(s-this.lastSpeedUpdate)/1e3;this.paused?(r=0,this.currentSpeed=0):a>=.5?(r=(this.totalBytesSent-this.lastBytesForSpeed)/a,this.currentSpeed=r,this.lastSpeedUpdate=s,this.lastBytesForSpeed=this.totalBytesSent):this.lastBytesForSpeed===0&&a>.1&&(r=this.totalBytesSent/a,this.currentSpeed=r),this.onProgress({bytesSent:this.totalBytesSent,totalBytes:this.file.size,percent:this.totalBytesSent/this.file.size*100,speedBps:r})}}}const nt="FileTransferDB",I="chunks";let A=null;const st=()=>new Promise((t,n)=>{const s=indexedDB.open(nt,1);s.onupgradeneeded=r=>{const a=r.target.result;a.objectStoreNames.contains(I)||a.createObjectStore(I,{keyPath:["fileName","chunkIndex"]})},s.onsuccess=r=>{A=r.target.result,t()},s.onerror=r=>n(r)}),rt=(t,n,s)=>A?new Promise((r,a)=>{const f=A.transaction(I,"readwrite");f.objectStore(I).put({fileName:t,chunkIndex:n,data:s}),f.oncomplete=()=>r(),f.onerror=()=>a(f.error)}):Promise.reject("DB not initialized"),at=t=>A?new Promise((n,s)=>{const a=A.transaction(I,"readonly").objectStore(I),f=IDBKeyRange.bound([t,0],[t,1/0]),m=a.openCursor(f),i=[];m.onsuccess=c=>{const p=c.target.result;p?(i.push(new Blob([p.value.data])),p.continue()):n(i)},m.onerror=()=>s(m.error)}):Promise.reject("DB not initialized"),ot=t=>A?new Promise((n,s)=>{const a=A.transaction(I,"readwrite").objectStore(I),f=IDBKeyRange.bound([t,0],[t,1/0]),m=a.delete(f);m.onsuccess=()=>n(),m.onerror=()=>s(m.error)}):Promise.reject("DB not initialized"),$=[];let Se=0,ne=!1;const it=t=>{$.push(t),Se+=t.data.byteLength,ne||ct()};async function ct(){for(ne=!0;$.length>0;){const t=$.shift();if(t){Se-=t.data.byteLength;try{await rt(t.fileName,t.chunkIndex,t.data)}catch{}}}ne=!1}class lt{constructor(n,s,r){S(this,"metadata");S(this,"onProgress");S(this,"onStatus");S(this,"totalBytesReceived",0);S(this,"receivedChunkCount",0);S(this,"lastSpeedUpdate",0);S(this,"lastBytesForSpeed",0);S(this,"lastUIUpdate",0);S(this,"currentSpeed",0);this.metadata=n,this.onProgress=s,this.onStatus=r,this.lastSpeedUpdate=Date.now()}handleChunk(n){const r=new DataView(n).getUint32(0,!0),a=n.slice(4);this.totalBytesReceived+=a.byteLength,this.receivedChunkCount++,this.updateStats(),it({fileName:this.metadata.name,chunkIndex:r,data:a}),this.receivedChunkCount%40===0&&b({type:"ack",chunkIndex:r,bytesReceived:this.totalBytesReceived}),this.totalBytesReceived>=this.metadata.size&&this.finalize()}updateStats(){const n=Date.now();if(n-this.lastUIUpdate>100||this.totalBytesReceived>=this.metadata.size){this.lastUIUpdate=n;let s=this.currentSpeed;const r=(n-this.lastSpeedUpdate)/1e3;r>=.5?(s=(this.totalBytesReceived-this.lastBytesForSpeed)/r,this.currentSpeed=s,this.lastSpeedUpdate=n,this.lastBytesForSpeed=this.totalBytesReceived):this.lastBytesForSpeed===0&&r>.1&&(s=this.totalBytesReceived/r,this.currentSpeed=s),this.onProgress({bytesReceived:this.totalBytesReceived,totalBytes:this.metadata.size,percent:this.totalBytesReceived/this.metadata.size*100,speedBps:s})}}async finalize(){for(this.onStatus("receiving","finalizing");$.length>0;)await new Promise(n=>setTimeout(n,50));try{const n=await at(this.metadata.name),s=new Blob(n,{type:this.metadata.mimeType});await ot(this.metadata.name),this.onStatus("complete",s),b({type:"file-complete",bytesReceived:this.totalBytesReceived})}catch(n){this.onStatus("error",n.message)}}}const dt=({roomId:t,onLeave:n})=>{const[s,r]=o.useState("idle"),[a,f]=o.useState(!1),[m,i]=o.useState(null),[c,p]=o.useState([]),[l,E]=o.useState(0),[R,P]=o.useState(null),[v,j]=o.useState("idle"),[G,u]=o.useState(null),y=o.useRef(null),[z,H]=o.useState(null),[ge,xe]=o.useState(null),[ve,T]=o.useState("idle"),[we,M]=o.useState(null),U=o.useRef(null),L=o.useRef(s),ae=o.useRef(v);o.useEffect(()=>{L.current=s},[s]),o.useEffect(()=>{ae.current=v},[v]);const je=()=>{navigator.clipboard.writeText(t),f(!0),setTimeout(()=>f(!1),2e3)},oe=o.useCallback((d,x)=>{},[]),ie=o.useCallback(d=>{switch(d.type){case"file-request":if(L.current==="sender")return;r("receiver"),H({name:d.name,size:d.size,mimeType:d.mimeType||"application/octet-stream"}),T("offering"),M(null);break;case"file-accept":L.current==="sender"&&ae.current==="waiting"&&y.current&&y.current.start();break;case"file-reject":L.current==="sender"&&(j("error"),u("Peer rejected file transfer."));break;case"ack":case"file-complete":break;case"cancel":L.current==="receiver"&&(T("error"),M("Transfer cancelled by sender."),U.current);break}},[]),ce=o.useCallback(d=>{U.current&&L.current==="receiver"&&U.current.handleChunk(d)},[]);o.useEffect(()=>{st().catch(()=>{}),fe(ie,ce,oe)},[ie,ce,oe]);const Ce=d=>{r("sender"),p(d),E(0),i(d[0]),j("idle"),u(null),P(null)},le=d=>{const x=d||m;x&&(y.current=new tt(x,k=>P(k),(k,B)=>{k==="uploading"&&j("uploading"),k==="complete"&&j("complete"),k==="error"&&(j("error"),u(B||"Unknown error"))}),j("waiting"),b({type:"file-request",name:x.name,size:x.size,mimeType:x.type}))};o.useEffect(()=>{if(v==="complete"&&l<c.length-1){const d=l+1;E(d),i(c[d]),j("idle"),P(null),setTimeout(()=>{le(c[d])},1e3)}},[v,l,c]);const Ne=()=>{y.current&&y.current.abort(),s==="sender"&&(v==="uploading"||v==="waiting"||v==="paused")&&b({type:"cancel"}),r("idle"),i(null),p([]),E(0)};o.useEffect(()=>{const d=x=>{t&&(x.preventDefault(),x.returnValue="")};return window.addEventListener("beforeunload",d),()=>window.removeEventListener("beforeunload",d)},[t]);const be=()=>{z&&(T("receiving"),U.current=new lt(z,d=>xe(d),(d,x)=>{d==="receiving"&&T("receiving"),d==="receiving"&&x==="finalizing"&&T("finalizing"),d==="complete"&&(T("complete"),Re(x,z.name)),d==="error"&&(T("error"),M(x))}),b({type:"file-accept"}))},Ee=()=>{b({type:"file-reject"}),r("idle"),H(null)},Re=(d,x)=>{const k=URL.createObjectURL(d),B=document.createElement("a");B.href=k,B.download=x,document.body.appendChild(B),B.click(),document.body.removeChild(B),setTimeout(()=>URL.revokeObjectURL(k),1e3)},Te=()=>{r("idle"),H(null),T("idle"),M(null),ke(null)},ke=d=>{U.current=d};return e.jsx("div",{className:"app-container",children:e.jsxs("div",{style:{maxWidth:"550px",width:"100%"},children:[e.jsxs("div",{className:"retro-card",style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1.5rem",padding:"1.2rem 1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx("div",{className:"font-mono text-muted",style:{fontSize:"0.85rem"},children:"ROOM"}),e.jsx("div",{className:"font-mono room-code",children:t}),e.jsx("button",{className:"retro-btn",style:{padding:"0.5rem 1rem",fontSize:"0.75rem"},onClick:je,children:a?"âœ“ COPIED":"COPY"})]}),e.jsx("button",{className:"retro-btn",onClick:n,style:{borderColor:"var(--accent-red)",color:"var(--accent-red)",padding:"0.5rem 1rem",fontSize:"0.75rem"},children:"LEAVE"})]}),e.jsx(et,{roomId:t}),e.jsx("div",{style:{marginTop:"2rem"},children:s==="receiver"?e.jsx(Le,{fileMetadata:z,progress:ge,status:ve,error:we,onAccept:be,onReject:Ee,onReset:Te}):e.jsx(Pe,{file:m,fileQueue:c,currentIndex:l,progress:R,status:v,error:G,onFilesSelect:Ce,onStart:()=>le(),onPause:()=>{y.current&&y.current.pause(),j("paused")},onResume:()=>{y.current&&y.current.resume(),j("uploading")},onAbort:Ne})}),e.jsx(ye,{})]})})},ut=({onJoin:t,onCreate:n})=>{const[s,r]=o.useState(""),a=()=>{s.length>0&&t(s.toUpperCase())};return e.jsxs("div",{className:"app-container",children:[e.jsx("h1",{style:{fontFamily:"var(--font-heading)",fontSize:"3rem",color:"var(--text-primary)",margin:0,textAlign:"center",marginBottom:"2rem"},children:"POJO FILES"}),e.jsx("div",{className:"retro-card",style:{width:"100%",maxWidth:"400px"},children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-mono text-muted",style:{fontSize:"0.9rem"},children:"ENTER ROOM CODE"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.5rem"},children:[e.jsx("input",{className:"retro-input",value:s,onChange:f=>r(f.target.value.toUpperCase()),placeholder:"A7X92B",maxLength:6,style:{textAlign:"center",letterSpacing:"0.2em",fontSize:"1.2rem",fontWeight:"bold"}}),e.jsx("button",{className:"retro-btn",onClick:a,disabled:s.length<3,children:"JOIN"})]})]}),e.jsx("div",{style:{textAlign:"center",opacity:.5,fontSize:"0.8rem"},className:"font-mono",children:"â€” OR â€”"}),e.jsx("button",{className:"retro-btn primary",onClick:n,children:"CREATE NEW ROOM"})]})}),e.jsx(ye,{})]})};function ht(){const[t,n]=o.useState(null);o.useEffect(()=>{const i=new Ae({duration:1.2,easing:p=>Math.min(1,1.001-Math.pow(2,-10*p))});function c(p){i.raf(p),requestAnimationFrame(c)}return requestAnimationFrame(c),window.scrollTo(0,0),()=>{i.destroy()}},[]);const s=()=>Math.random().toString(36).substring(2,8).toUpperCase(),r=async(i,c)=>{n(i),de(i);const p=new URL(window.location.href);p.searchParams.set("room",i),window.history.pushState({},"",p.toString());try{await he(),_e(async l=>{if(l.type==="joined"&&l.isInitiator,l.type==="peer-joined"){if(c){const E=ee(i,!0),R=await E.createOffer();await E.setLocalDescription(R),F({type:"offer",offer:R,room:i})}}else l.type==="room-state"?l.peerCount&&l.peerCount>1:l.type==="offer"?c||(ee(i,!1),l.offer&&await Xe(l.offer)):l.type==="answer"?c&&l.answer&&await Qe(l.answer):l.type==="ice-candidate"&&l.candidate&&await Ze(l.candidate)})}catch{}};o.useEffect(()=>{const c=new URLSearchParams(window.location.search).get("room");if(c){const p=sessionStorage.getItem("isInitiator")==="true";r(c,p)}},[]);const a=()=>{const i=s();sessionStorage.setItem("isInitiator","true"),r(i,!0)},f=i=>{sessionStorage.setItem("isInitiator","false"),r(i,!1)},m=()=>{n(null),sessionStorage.removeItem("isInitiator"),de("");const i=new URL(window.location.href);i.searchParams.delete("room"),window.history.pushState({},"",i.toString()),window.location.reload()};return t?e.jsx(dt,{roomId:t,onLeave:m}):e.jsx(ut,{onJoin:f,onCreate:a})}const yt=()=>e.jsx(ht,{});export{yt as default};
